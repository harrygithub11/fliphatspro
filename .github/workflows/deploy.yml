name: Deploy to Fliphats.com VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          script: |
            # Navigate to the project directory
            cd /home/fliphats/htdocs/fliphats.com

            # Pull the latest code
            cd /home/fliphats/htdocs/fliphats.com
            
            # Ensure git trusts this directory (prevents dubious ownership error)
            git config --global --add safe.directory /home/fliphats/htdocs/fliphats.com || true
            
            git pull origin main
            npm install
            npx prisma generate
            npx tsx scripts/fix-db-dates.ts
            npx prisma db push --accept-data-loss
            
            # Clean previous build to prevent ENOTEMPTY error
            rm -rf .next
            
            # Build the application
            npm run build

            # Restart application with force delete to ensure clean slate
            pm2 delete fliphatspro-web || true
            pm2 start npm --name "fliphatspro-web" -- start
            
            pm2 restart fliphatspro-worker --update-env || echo "Worker checked"
            pm2 restart fliphatspro-imap --update-env || echo "IMAP checked"
            
            # Save PM2 process list so it survives reboot
            pm2 save